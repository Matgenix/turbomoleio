

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>turbomoleio.input.define &mdash; turbomoleio 1.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> turbomoleio
          

          
          </a>

          
            
            
              <div class="version">
                1.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../datagroups.html">The data group files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coord.html">The coord file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../definerunner.html">Running define</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output_parsing.html">Outputs parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/introduction.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/parsing_logs.html">Output logs parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/definerunner.html">Define runner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/versioning.html">Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/versioning.html#backward-compatibility">Backward-compatibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bugs.html">Reporting bugs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">turbomoleio</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>turbomoleio.input.define</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for turbomoleio.input.define</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># The turbomoleio package, a python interface to Turbomole</span>
<span class="c1"># for preparing inputs, parsing outputs and other related tools.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2018-2022 BASF SE, Matgenix SRL.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of turbomoleio.</span>
<span class="c1">#</span>
<span class="c1"># Turbomoleio is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># Turbomoleio is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with turbomoleio (see ~turbomoleio/COPYING). If not,</span>
<span class="c1"># see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Module with classes and functions to run define.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">pexpect</span>
<span class="kn">from</span> <span class="nn">monty.os</span> <span class="kn">import</span> <span class="n">cd</span>

<span class="kn">from</span> <span class="nn">turbomoleio.core.control</span> <span class="kn">import</span> <span class="n">Control</span><span class="p">,</span> <span class="n">cdg</span><span class="p">,</span> <span class="n">mdgo</span><span class="p">,</span> <span class="n">sdg</span>


<div class="viewcode-block" id="DefineError"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineError">[docs]</a><span class="k">class</span> <span class="nc">DefineError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base exception for define errors.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct DefineError object.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): the message describing the error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span></div>


<div class="viewcode-block" id="DefineExpectError"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineExpectError">[docs]</a><span class="k">class</span> <span class="nc">DefineExpectError</span><span class="p">(</span><span class="n">DefineError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised when an expect fail, going in timeout or EOF.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct DefineExpectError object.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): the message describing the error</span>
<span class="sd">            pattern (list): the pattern passed to define that failed to be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span></div>


<div class="viewcode-block" id="DefineParameterError"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineParameterError">[docs]</a><span class="k">class</span> <span class="nc">DefineParameterError</span><span class="p">(</span><span class="n">DefineError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when parameters are not defined properly.</span>

<span class="sd">    This happens when the options are, e.g. incompatible among them or</span>
<span class="sd">    with the other files provided, like coord or a previous control.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="DefineIredError"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineIredError">[docs]</a><span class="k">class</span> <span class="nc">DefineIredError</span><span class="p">(</span><span class="n">DefineError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised for problems related to the generation of internal coordinates.</span>

<span class="sd">    Even in the case of incomplete set in internal coordinates and ired is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="UnsupportedDefineStateError"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.UnsupportedDefineStateError">[docs]</a><span class="k">class</span> <span class="nc">UnsupportedDefineStateError</span><span class="p">(</span><span class="n">DefineError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception for unexpected behavior of define.</span>

<span class="sd">    This exception is raised when, according to the current implementation,</span>
<span class="sd">    a specific behavior is expected from define, but a proper way of handling</span>
<span class="sd">    with the case has not been implemented.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="DefineRunner"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineRunner">[docs]</a><span class="k">class</span> <span class="nc">DefineRunner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class that runs the define executable.</span>

<span class="sd">    This uses pexpect to communicate with the code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="o">=</span><span class="s2">&quot;define.log&quot;</span><span class="p">,</span>
        <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_popen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a DefineRunner object.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameters (dict): dictionary with the parameters defining the execution.</span>
<span class="sd">                The dictionary will be copied to avoid side effects during</span>
<span class="sd">                the execution.</span>
<span class="sd">            timeout (int): integer with the maximum time waited by &quot;expect&quot; before</span>
<span class="sd">                raising a timeout exception.</span>
<span class="sd">            log_filepath (str): string with a path to the file used to log the input</span>
<span class="sd">                and output of define. If None no log will be created.</span>
<span class="sd">            workdir (str): directory where the define will be executed.</span>
<span class="sd">                If None runs in the current directory.</span>
<span class="sd">            executable (str): path to the executable that will be used to run define.</span>
<span class="sd">                If None will first search in an environment variable and then default</span>
<span class="sd">                to &quot;define&quot;, that should be in the $PATH.</span>
<span class="sd">            use_popen (bool): if True the pexpect.popen_spawn.PopenSpawn</span>
<span class="sd">                implementation of pexpect based on popen is used.</span>
<span class="sd">                Otherwise the standard spawn (based on pty).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_filepath</span> <span class="o">=</span> <span class="n">log_filepath</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_popen</span> <span class="o">=</span> <span class="n">use_popen</span>
        <span class="c1"># set the internal value with the spawn command that should be used based when</span>
        <span class="c1"># starting pexpect</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_popen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">popen_spawn</span><span class="o">.</span><span class="n">PopenSpawn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span>

    <span class="k">def</span> <span class="nf">_expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run self.define.expect with the options provided.</span>

<span class="sd">        Handles the timeout and eof exceptions, logs and raises them as</span>
<span class="sd">        specific define exceptions.</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern: the pattern given to pexpect.expect(). See pexpect</span>
<span class="sd">                documentations for more details.</span>
<span class="sd">            timeout (int): number of second that should be waited before</span>
<span class="sd">                raising the TIMEOUT exception. The default (-1) keeps the</span>
<span class="sd">                timeout value set in spawn.</span>
<span class="sd">            action (str): a string describing the action that is being performed.</span>
<span class="sd">                Will be used for logging and tracing of errors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The index of the options provided, as returned by pexpect.expect().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;Expect: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot;. Action: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EOF</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Expect could not find the pattern: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_alive</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; The job was alive.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; The job was not alive.&quot;</span>
            <span class="k">raise</span> <span class="n">DefineExpectError</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sendline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call self.define.sendline.</span>

<span class="sd">        This logs the action and the list of commands sent.</span>

<span class="sd">        Args:</span>
<span class="sd">            line (str): a string with the line that should be sent to define.</span>
<span class="sd">            action (str): a string describing the action that is being performed.</span>
<span class="sd">                Will be used for logging and tracing of errors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;Sendline: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot;. Action: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the process is alive.</span>

<span class="sd">        This calls the correct method depending on the pexpect implementation</span>
<span class="sd">        used (popen or pty).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True is the process is alive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_popen</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">isalive</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close or kill the connection with the child application.</span>

<span class="sd">        This depends on the pexpect implementation used (popen or pty).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_popen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_alive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_bin_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Give the path to the define executable based on the parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The path to the define executable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bin_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_path</span><span class="p">:</span>
            <span class="n">bin_path</span> <span class="o">=</span> <span class="s2">&quot;define&quot;</span>

        <span class="k">return</span> <span class="n">bin_path</span>

<div class="viewcode-block" id="DefineRunner.run_full"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineRunner.run_full">[docs]</a>    <span class="k">def</span> <span class="nf">run_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run define going through all the menus using the parameters.</span>

<span class="sd">        If The jobs reaches the end without exceptions being raised it</span>
<span class="sd">        will check if the job ended normally or abnormally.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if define ended normally otherwise abnormally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">()</span>

        <span class="n">ended_normally</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_bin_path</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_control</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="c1"># coordinate menu</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_menu</span><span class="p">(</span><span class="n">new_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># leave the previous menu and move to the next one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_switch_to_atomic_attribute_menu</span><span class="p">()</span>

                    <span class="c1"># atomic attribute menu - only basis set is used here</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_define_basis_sets</span><span class="p">()</span>

                    <span class="c1"># leave the previous menu and move to the next one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_switch_to_molecular_orbital_definition_menu</span><span class="p">()</span>

                    <span class="c1"># molecular orbital definition menu</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;usemo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_mo_from_control_file</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_extended_hueckel_theory_menu</span><span class="p">()</span>

                    <span class="c1"># excited state menu</span>
                    <span class="n">ex_keys</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;ex_method&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ex_multi&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ex_irrep_states&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ex_all_states&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ex_frequency&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ex_exopt&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ex_keys</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;adc(2)&quot;</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_excited_state_menu</span><span class="p">()</span>

                    <span class="c1"># general menu</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_general_menu</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_quit_general_menu</span><span class="p">()</span>

                    <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;define ended normally&quot;</span><span class="p">,</span> <span class="s2">&quot;define ended abnormally&quot;</span><span class="p">],</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;check end of define&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ended_normally</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># wait for the EOF with a timeout</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;wait for EOF&quot;</span><span class="p">)</span>

                    <span class="c1"># this is a blocking call. It may be removed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># Always close define</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;copymo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_copy_mo_files</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ended_normally</span></div>

<div class="viewcode-block" id="DefineRunner.run_update_internal_coords"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineRunner.run_update_internal_coords">[docs]</a>    <span class="k">def</span> <span class="nf">run_update_internal_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the define to update internal coordinates of the system.</span>

<span class="sd">        This is run in a folder where a control file is already present and</span>
<span class="sd">        uses the parameters to update the internal coordinates of the system.</span>
<span class="sd">        Quits afterwards terminating define &quot;abnormally&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if internal coordinates were successfully updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_bin_path</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_control</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># coordinate menu</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_menu</span><span class="p">(</span><span class="n">new_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave geometry menu&quot;</span><span class="p">)</span>

                    <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="s2">&quot;GEOMETRY DATA WILL BE WRITTEN TO FILE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;IF YOU DO NOT WANT TO USE INTERNAL COORDINATES ENTER&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">coords_updated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">DefineIredError</span><span class="p">(</span>
                            <span class="s2">&quot;An incomplete set of internal coordinate is present &quot;</span>
                            <span class="s2">&quot;with ired True&quot;</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;qq&quot;</span><span class="p">,</span> <span class="s2">&quot;quit after geometry modification&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;define ended abnormally&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;check end of define&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># wait for the EOF with a timeout</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;wait for EOF&quot;</span><span class="p">)</span>

                    <span class="c1"># this is a blocking call. It may be removed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># Always close define</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">coords_updated</span></div>

<div class="viewcode-block" id="DefineRunner.run_generate_mo_files"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineRunner.run_generate_mo_files">[docs]</a>    <span class="k">def</span> <span class="nf">run_generate_mo_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run define to regenerate the molecular orbital files.</span>

<span class="sd">        This must be run  in a folder where a control file is already present</span>
<span class="sd">        and only regenerates the molecular orbital files. If the usemo option</span>
<span class="sd">        is defined the related molecular orbital will be taken from there and</span>
<span class="sd">        updated, otherwise they will be generated from scratch with the extended</span>
<span class="sd">        hueckel guess. (N.B. the control should not be the one currently being edited</span>
<span class="sd">        by define)</span>

<span class="sd">        Also allows to change some information in the geometry. If at least one</span>
<span class="sd">        of the following options is enabled it will enter the geometry menu:</span>
<span class="sd">        sym, desy, ired. Notice that if the geometry menu should be skipped these</span>
<span class="sd">        options should be disabled.</span>

<span class="sd">        Quits terminating define &quot;abnormally&quot;.</span>

<span class="sd">        The function can only return True or fail with an exception.</span>
<span class="sd">        The return value is given to provide an interface similar to the other</span>
<span class="sd">        running methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: always returns True if the function completes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_bin_path</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_control</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># False if all the options are False, None or empty strings</span>
                    <span class="n">update_geom</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sym&quot;</span><span class="p">,</span> <span class="s2">&quot;desy&quot;</span><span class="p">,</span> <span class="s2">&quot;ired&quot;</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_menu</span><span class="p">(</span><span class="n">new_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update_geom</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_skip_atomic_attribute_menu</span><span class="p">(</span><span class="n">update_geom</span><span class="p">)</span>

                    <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="s2">&quot;.*MOLECULAR ORBITAL DEFINITION.*&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;MOLECULAR ORBITAL DATA.*DO YOU WANT TO CHANGE THESE DATA&quot;</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to molecular orbital definition menu&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start modification of mo data&quot;</span><span class="p">)</span>

                    <span class="c1"># molecular orbital definition menu</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;usemo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_mo_from_control_file</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_extended_hueckel_theory_menu</span><span class="p">()</span>

                    <span class="c1"># quit here. At this point some questions may still be asked</span>
                    <span class="c1"># (like if some groups should be deleted or similar).</span>
                    <span class="c1"># They do not seem to affect the generation of the mos, that</span>
                    <span class="c1"># has already been completed, and will add more complication</span>
                    <span class="c1"># without any particular benefit.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;qq&quot;</span><span class="p">,</span> <span class="s2">&quot;quit after geometry modification&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;define ended abnormally&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;check end of define&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># wait for the EOF with a timeout</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;wait for EOF&quot;</span><span class="p">)</span>

                    <span class="c1"># this is a blocking call. It may be removed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># Always close define</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the metric.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">):</span>
                <span class="c1"># create the control file with redund_inp/metric entry</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Control</span><span class="o">.</span><span class="n">from_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">])</span>
                <span class="n">c</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mdgo</span><span class="p">(</span>
                    <span class="s2">&quot;$redund_inp&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;  metric </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">])},</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the control file using define.</span>

<span class="sd">        This checks if a control file is already existing in the folder</span>
<span class="sd">        and sets the title.</span>
<span class="sd">        If update is True a previous control file should be present.</span>

<span class="sd">        Args:</span>
<span class="sd">            update (bool): determines if the current run is supposed to</span>
<span class="sd">                update a fully defined control.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;DATA WILL BE TAKEN FROM control BY DEFAULT&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DATA WILL BE WRITTEN TO THE NEW FILE control&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start inizialize control&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># appending data to fragmentary control file</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DefineError</span><span class="p">(</span>
                    <span class="s2">&quot;No control file in the folder </span><span class="si">{}</span><span class="s2">. Required for update&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;don&#39;t use other control files&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;INPUT TITLE&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;initialize control title&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set title&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;no or default title&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_geometry_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the options for the molecule geometry menu.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_coords (bool): if True it expects that the coordinates should</span>
<span class="sd">                be updated in a previously existing control file.</span>
<span class="sd">            update (bool): whether already present coordinates should be updated</span>
<span class="sd">                or not (i.e. update internal coordinates).</span>
<span class="sd">                Ignored if new_coord is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            DefineError if incompatibility between current folder state and new_coords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the first case should be when update is False, other cases should only</span>
        <span class="c1"># happen when in update, since the coord file is read immediately.</span>
        <span class="c1"># The message with SCHOENFLIES SYMBOL happens when a symbol incompatible</span>
        <span class="c1"># with the structure is present in control.</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DO YOU WANT TO CHANGE THE GEOMETRY DATA&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CARTESIAN COORDINATES AND VALUES OF &quot;</span>
                <span class="s2">&quot;INTERNAL COORDINATES DO  N O T   AGREE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;THESE COORDINATES AND SCHOENFLIES SYMBOL ARE IGNORED&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start geometry menu&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">new_coords</span> <span class="ow">and</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">new_coords</span> <span class="ow">and</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
            <span class="n">which_calc</span> <span class="o">=</span> <span class="s2">&quot;full define&quot;</span> <span class="k">if</span> <span class="n">new_coords</span> <span class="k">else</span> <span class="s2">&quot;update&quot;</span>
            <span class="n">present</span> <span class="o">=</span> <span class="s2">&quot;not &quot;</span> <span class="k">if</span> <span class="n">update</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">raise</span> <span class="n">DefineError</span><span class="p">(</span>
                <span class="s2">&quot;To run a </span><span class="si">{}</span><span class="s2"> previous data should </span><span class="si">{}</span><span class="s2">be present&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">which_calc</span><span class="p">,</span> <span class="n">present</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">new_coords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_atomic_coordinates_from_file</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_existing_coordinates</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>

        <span class="c1"># if the section should be skipped this will not be used.</span>
        <span class="k">if</span> <span class="n">new_coords</span> <span class="ow">or</span> <span class="n">update</span><span class="p">:</span>
            <span class="c1"># if copymo is set, use the symmetry of control file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;copymo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;sym&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdg</span><span class="p">(</span>
                    <span class="s2">&quot;$symmetry&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;copymo&quot;</span><span class="p">],</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_define_symmetry</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_determine_symmetry</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ired&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_internal_coordinates</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_general_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all the options for the general menu.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;dft&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dft_options</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;hf&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dft_options</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mp2&quot;</span><span class="p">,</span> <span class="s2">&quot;ccsdt&quot;</span><span class="p">,</span> <span class="s2">&quot;ccsd(t)&quot;</span><span class="p">,</span> <span class="s2">&quot;adc(2)&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ccsdt&quot;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;ccsd(t)&quot;</span>

            <span class="c1"># switch off ri for rimp2.</span>
            <span class="c1"># ri-flag means ri for ridft in this context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">energy_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mp2energy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># perform mp2 settings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_mp2_options</span><span class="p">(</span><span class="n">energy_only</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span><span class="s2">&quot;Unknown method </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_scf_options</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ri_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_atomic_coordinates_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add atomic coordinates from a file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coord_file&quot;</span><span class="p">,</span> <span class="s2">&quot;coord&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;a </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set coordinates from file&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;CARTESIAN COORDINATES AND VALUES OF INTERNAL &quot;</span>
                <span class="s2">&quot;COORDINATES DO  N O T   AGREE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;atomic coordinates from file&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># take cartesian coordinates as default</span>
            <span class="c1"># if cartesian and internal do not match</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;choose cartesian coordinates&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end atomic coordinates from file&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_existing_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the coordinates menu for a previously existing control file.</span>

<span class="sd">        Args:</span>
<span class="sd">            case (int): The first case received from leaving the title menu.</span>
<span class="sd">                Should not be 0.</span>
<span class="sd">            update (bool): whether already present coordinates should be updated</span>
<span class="sd">                or not (i.e. update internal coordinates).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> <span class="k">if</span> <span class="n">update</span> <span class="k">else</span> <span class="s2">&quot;n&quot;</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;change the geometry data&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;keep cartesian coordinates&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;DO YOU WANT TO CHANGE THE GEOMETRY DATA&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update coordinates&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;change the geometry data&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedDefineStateError</span><span class="p">(</span><span class="s2">&quot;Coordinates cannot be simply updated.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineError</span><span class="p">(</span><span class="s2">&quot;Incompatible choice with update coordinates&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end existing coordinates&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_define_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the symmetry with the &quot;sy&quot; key when &quot;sym&quot; is among the parameters.</span>

<span class="sd">        This also adds the tolerance if sym_eps is present.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
            <span class="s2">&quot;sy </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;sym&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sym_eps&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;specify symmetry&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;INVALID SCHOENFLIES SYMBOL&quot;</span><span class="p">,</span> <span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY.*&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end define symmetry&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                <span class="s2">&quot;Wrong symmetry symbol: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;sym&quot;</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_determine_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Let define determine the symmetries when the &quot;desy&quot; is present and True.</span>

<span class="sd">        This also adds the tolerance if &quot;desy_eps&quot; is present.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;determine symmetry&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desy_eps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;desy&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;desy </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;desy_eps&quot;</span><span class="p">]),</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end determine symmetry&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_internal_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the redundant internal coordinates when &quot;ired&quot; is among the keys.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;ired&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;generate redundant internal coordinates&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;SPECIFICATION OF MOLECULAR GEOMETRY.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CAUTION, within .*? steps NO convergence&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;THE B\*m\*Bt-MATRIX IS SINGULAR&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end generate internal coordinates&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DefineIredError</span><span class="p">(</span><span class="s2">&quot;Some error occurred during the ired procedure.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_switch_to_atomic_attribute_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to atomic attribute menu after setting the coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to atomic attribute menu&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;IF YOU DO NOT WANT TO USE INTERNAL COORDINATES ENTER*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ATOMIC ATTRIBUTE DEFINITION MENU.*&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to atomic attribute menu&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ired&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DefineIredError</span><span class="p">(</span>
                    <span class="s2">&quot;An incomplete set of internal coordinate is present with ired True&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;discard internal coords when leaving geometry menu&quot;</span>
            <span class="p">)</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ATOMIC ATTRIBUTE DEFINITION MENU.*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end switch to atomic attribute menu&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_skip_atomic_attribute_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_geometry_menu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to atomic attribute menu after setting the coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_geometry_menu (bool): if True the code start at the moment of</span>
<span class="sd">                closing the geometry menu. Otherwise the the geometry menu has</span>
<span class="sd">                been entirely skipped before.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_geometry_menu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to atomic attribute menu&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;ATOMIC ATTRIBUTE DATA.*DO YOU WANT TO CHANGE THESE DATA&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ATOMIC ATTRIBUTE DEFINITION MENU.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;IF YOU DO NOT WANT TO USE INTERNAL COORDINATES ENTER*&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;skip to atomic attribute menu&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if needed keep cartesian coordinate and expect again the other options</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;discard internal coords when leaving geometry menu&quot;</span>
            <span class="p">)</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ATOMIC ATTRIBUTE DATA.*DO YOU WANT TO CHANGE THESE DATA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ATOMIC ATTRIBUTE DEFINITION MENU.*&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;end skip to atomic attribute menu&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;do not enter in the atomic attribute menu&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># here define entered in the definition of the menu, meaning that the</span>
            <span class="c1"># atomic properties are not defined. This case is not supported here.</span>
            <span class="k">raise</span> <span class="n">UnsupportedDefineStateError</span><span class="p">(</span>
                <span class="s2">&quot;atomic menu should be already filled, but apparently it is not&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">basis</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the atomic basis set.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_type (str): defines the type type of atom(s) addressed. Can be &quot;all&quot;,</span>
<span class="sd">                a list &quot;1,2,4-6&quot; or the atomic specie &quot;\&quot;c\&quot;&quot; (quotes are required).</span>
<span class="sd">            basis (stR): the type of basis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to basis menu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;ENTER A SET OF ATOMS TO WHICH YOU WANT TO ASSIGN BASIS SETS.*&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set basis&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">basis</span><span class="p">))</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;ATOMIC ATTRIBUTE DEFINITION MENU.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;THERE ARE NO DATA SETS CATALOGUED IN FILE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set basis&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                <span class="s2">&quot;Define did not recognize basis </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_define_basis_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the basis set.</span>

<span class="sd">        This uses the &quot;basis&quot; and &quot;basis_atom&quot; keywords in the parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_basis</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis_atom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">basis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis_atom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># convert to string in case an integer slips through since it can</span>
                <span class="c1"># also represent an index.</span>
                <span class="n">atom_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># if it is a symbol and does not already contain quotations add them.</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="s2">&quot;[A-Za-z]+&quot;</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">):</span>
                    <span class="n">atom_type</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_set_basis</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_switch_to_molecular_orbital_definition_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to the molecular orbital definition menu.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to molecular orbital definition menu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;.*MOLECULAR ORBITAL DEFINITION.*&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;switch to molecular orbital definition menu&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_to_general_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Go back to the general menu.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># go back to general menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to general menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to general menu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_mo_from_control_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the molecular orbitals from a previous control file.</span>

<span class="sd">        The molecular orbitals are set from a previous control file when the path</span>
<span class="sd">        is present in the &quot;usemo&quot; key is in the options.</span>
<span class="sd">        It checks the actual presence of the file.</span>

<span class="sd">        TODO needs to be checked if it works with alpha/beta as well and if it should.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;usemo&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">control_path</span><span class="p">):</span>
            <span class="n">control_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">control_path</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">control_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                <span class="s2">&quot;No control file at the path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">control_path</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Apparently define doesn&#39;t like long paths. Try with a relative one</span>
            <span class="c1"># if it is too long. The limit seems to be 77 letters.</span>
            <span class="c1"># Keep lower value to stay on the safe side.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">control_path</span><span class="p">)</span>

                <span class="c1"># if still too long create a symbolic link to the folder</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">control_path</span><span class="p">),</span> <span class="s2">&quot;tmp_mo&quot;</span><span class="p">)</span>
                    <span class="n">control_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s2">&quot;tmp_mo&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">control_path</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">control_path</span> <span class="o">=</span> <span class="n">rel_path</span>

            <span class="c1"># set path for usemo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="s2">&quot;use </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">control_path</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set mo from control file&quot;</span>
            <span class="p">)</span>

            <span class="c1"># leave the atomic attribute menu</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;DO YOU REALLY WANT TO WRITE OUT NATURAL ORBITALS.*&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LEFT OVER FROM PREVIOUS CALCULATIONS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;DO YOU REALLY WANT TO USE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TO CONTINUE, ENTER &lt;return&gt;&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to general menu after use mo&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;continue&quot;</span><span class="p">)</span>
                <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;DO YOU REALLY WANT TO WRITE OUT NATURAL ORBITALS.*&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;LEFT OVER FROM PREVIOUS CALCULATIONS&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;DO YOU REALLY WANT TO USE&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to general menu after use mo&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="c1"># 0 is if we are already in the general menu, everything is ok.</span>
                <span class="c1"># Other cases cover messages when regenerating the mo files.</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;tmp_mo&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s2">&quot;tmp_mo&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extended_hueckel_theory_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the whole menu of the extended Hueckel theory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;eht&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start menu for extended Hueckel theory&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;FOUND ATOMIC ORBITALS.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DO YOU WANT THE DEFAULT PARAMETERS FOR THE EXTENDED &quot;</span>
                <span class="s2">&quot;HUECKEL CALCULATION.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DO YOU WANT THESE*&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;initial choice of menu for extended Hueckel theory&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># send default (=y; take orbitals that have been found)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default values for Hueckel&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;DO YOU WANT THE DEFAULT PARAMETERS FOR THE EXTENDED &quot;</span>
                    <span class="s2">&quot;HUECKEL CALCULATION.*&quot;</span>
                <span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default values for Hueckel&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># extended hueckel will be treated in next block</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># send default (=y)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default values for Hueckel&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;DO YOU WANT THE DEFAULT PARAMETERS FOR THE EXTENDED &quot;</span>
                    <span class="s2">&quot;HUECKEL CALCULATION.*&quot;</span>
                <span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default values for Hueckel&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># send default (=y; use default parameters for extended hueckel calculation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default values for Hueckel&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;ENTER THE MOLECULAR CHARGE*&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;finish setting default values for Hueckel&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set molecular charge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># use given charge</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]),</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set molecular charge for Hueckel&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use default (=0)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set 0 charge for Hueckel&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;DO YOU ACCEPT THIS OCCUPATION.*&quot;</span><span class="p">,</span> <span class="s2">&quot;OCCUPATION NUMBER ASSIGNMENT MENU*&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;charge for Hueckel&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">unpaired_electrons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unpaired_electrons&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unpaired_electrons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;don&#39;t keep default electrons occupation&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;OCCUPATION NUMBER ASSIGNMENT MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;unpaired electrons&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># send default (=y; of course we accept this occupation...)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;don&#39;t keep default electrons occupation&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unpaired_electrons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                    <span class="s2">&quot;unpaired_electrons keywork is required if no default is present&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">unpaired_electrons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="s2">&quot;u </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unpaired_electrons</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set unpaired electrons&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;OCCUPATION NUMBER ASSIGNMENT MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set unpaired electrons&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave the unpaired electron menu&quot;</span><span class="p">)</span>

        <span class="c1"># leave the atomic attribute menu</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DO YOU REALLY WANT TO WRITE OUT NATURAL ORBITALS.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LEFT OVER FROM PREVIOUS CALCULATIONS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DO YOU REALLY WANT TO USE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to general menu after huckel&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="c1"># 0 is if we are already in the general menu, everything is ok.</span>
            <span class="c1"># Other cases cover messages when regenerating the mo files.</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_excited_state_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the whole excited state menu.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if values are set, set default values if not</span>
        <span class="n">ex_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_method&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">)</span>
        <span class="n">ex_multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_multi&quot;</span><span class="p">,</span> <span class="s2">&quot;singlet&quot;</span><span class="p">)</span>
        <span class="n">ex_irrep_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_irrep_states&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ex_all_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ex_all_states&quot;</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ex_irrep_states</span> <span class="k">else</span> <span class="mi">10</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_frequency&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># d-linie in nm for natrium</span>
            <span class="n">ex_frequency</span> <span class="o">=</span> <span class="s2">&quot;589&quot;</span>
            <span class="n">ex_frequency_unit</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex_frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ex_frequency&quot;</span><span class="p">]</span>
            <span class="n">ex_frequency_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_frequency_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;nm&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_exopt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cdg</span><span class="p">(</span><span class="s2">&quot;$exopt&quot;</span><span class="p">,</span> <span class="s2">&quot;    </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_exopt&quot;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;move to response calculations menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;MAIN MENU FOR RESPONSE CALCULATIONS&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start excited states&quot;</span>
        <span class="p">)</span>

        <span class="c1"># search the match with the list of available response calculation options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;----.*ENTER &lt;OPTION&gt; TO SWITCH ON/OFF OPTION&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;identify available response calculations&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">response_opt_avail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;OPTION&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;----&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
            <span class="n">response_opt_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># we assume that in the list of available options there will be either</span>
        <span class="c1"># only &quot;urpa&quot; or both &quot;rpas&quot; and &quot;rpat&quot;. Here we check that this is</span>
        <span class="c1"># actually the case.</span>
        <span class="c1"># Potentially this should not happen, but check to avoid setting the</span>
        <span class="c1"># wrong options. The same for &quot;ucis&quot;, &quot;ciss&quot; &quot;cist&quot;.</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cis&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">):</span>
            <span class="n">opt1</span> <span class="o">=</span> <span class="s2">&quot;u</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">response_opt_avail</span>
            <span class="n">opt2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">response_opt_avail</span>
                <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">t&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">response_opt_avail</span>
            <span class="p">)</span>
            <span class="c1"># this is a NOT XOR as we want exactly one of the cases to be true</span>
            <span class="k">if</span> <span class="n">opt1</span> <span class="o">==</span> <span class="n">opt2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedDefineStateError</span><span class="p">(</span>
                    <span class="s2">&quot;The current list response options is not compatible &quot;</span>
                    <span class="s2">&quot;with the choices for cis and rpa: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response_opt_avail</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">ex_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cis&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;u</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex_method</span><span class="p">)</span> <span class="ow">in</span> <span class="n">response_opt_avail</span><span class="p">:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="s2">&quot;u</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex_method</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex_method</span><span class="p">,</span> <span class="n">ex_multi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">ex_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dynpol&quot;</span><span class="p">,</span> <span class="s2">&quot;polly&quot;</span><span class="p">):</span>
            <span class="n">option</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex_method</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                <span class="s2">&quot;ex_method not among the supported values: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex_method</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># this check should be redundant, but an error can still occur</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response_opt_avail</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Option </span><span class="si">{}</span><span class="s2"> is not present among those available: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">response_opt_avail</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excited state option&quot;</span><span class="p">)</span>
        <span class="c1"># search the match with the list of available response calculation options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;----.*ENTER &lt;OPTION&gt; TO SWITCH ON/OFF OPTION&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;check that the option has been activated&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">option</span> <span class="ow">and</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;on&quot;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefineError</span><span class="p">(</span><span class="s2">&quot;Option </span><span class="si">{}</span><span class="s2"> was not activated&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave response calculation main menu&quot;</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;STATE SELECTION MENU&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SELECT FREQUENCY UNIT*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GENERAL OPTIONS FOR RESPONSE CALCULATIONS*&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;after response calculation main menu&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># search the match with the list of available irreps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;----.*SELECT IRREP AND NUMBER OF STATES&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;identify available irreps&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">irreps_avail</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;IRREP&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;----&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="c1"># The line can also contain &quot;    |   |   | xz yz&quot;, being the</span>
                <span class="c1"># continuation of the line above.</span>
                <span class="c1"># Skip all the lines whose second split cannot be converted to int.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">num_states</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">irreps_avail</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">num_states</span>

            <span class="c1"># only use number of states that are &lt;= than those available</span>
            <span class="n">selected_irreps</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">ex_all_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">irreps_avail</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">selected_irreps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex_all_states</span> <span class="k">if</span> <span class="n">ex_all_states</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="k">else</span> <span class="n">n</span>

            <span class="k">if</span> <span class="n">ex_irrep_states</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ex_irrep_states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irreps_avail</span><span class="p">:</span>
                        <span class="n">selected_irreps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">irreps_avail</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">irreps_avail</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_irreps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                    <span class="s2">&quot;No excited state could be set given the input parameters&quot;</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">selected_irreps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excited states number for specific irrep&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;STATE SELECTION MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to state selection menu&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave excited states menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;GENERAL OPTIONS FOR RESPONSE CALCULATIONS*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to response calulation menu&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex_frequency_unit</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitation units&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;FREQUENCY INPUT MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitations&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;INPUT FREQUENCY NO.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitations&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex_frequency</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitation frequency&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;INPUT FREQUENCY NO.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitations&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave frequency menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;FREQUENCY INPUT MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excitations&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave excited states menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;GENERAL OPTIONS FOR RESPONSE CALCULATIONS*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to response calulation menu&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># already at the end of the other cases</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;leave excited states menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;SET SCF DENSITY CONVERGENCE THRESHOLD*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;excited states: scf&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;default for density convergence threshold&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_ri_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the parameters for ri calculation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rijk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;rijk&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;choose rijk option&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER RI-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ri menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;activate rijk option&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER RI-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ri menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ri&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;ri&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;choose ri option&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER RI-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ri menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;activate ri option&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER RI-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ri menu&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;marij&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;marij&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;choose marij option&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;Enter the number to change a value or &lt;return&gt; to accept all.*&quot;</span><span class="p">],</span>
                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ri menu&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;accept all&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to general menu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_dft_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_dft</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the dft options.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;dft&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;move to dft menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER DFT-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start dft options&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_dft</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;enable dft&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER DFT-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to dft options&quot;</span>
            <span class="p">)</span>

            <span class="n">functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="s2">&quot;b-p&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;func </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set functional&quot;</span><span class="p">)</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ENTER DFT-OPTION TO BE MODIFIED.*&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SPECIFIED FUNCTIONAL not SUPPORTED&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to dft options&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                    <span class="s2">&quot;XC functional not supported by define: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridsize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                    <span class="s2">&quot;grid </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;gridsize&quot;</span><span class="p">]),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set gridsize&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ENTER DFT-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to dft options&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;disable dft&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER DFT-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to dft options&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_mp2_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mp2&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set mp2 options.</span>

<span class="sd">        Args:</span>
<span class="sd">            energy_only (bool): if true the job is energy only.</span>
<span class="sd">            method (str): the method used for the mp2 calculation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># change to mp2 menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;cc&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;change to mp2 menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;start ricc2 options&quot;</span>
        <span class="p">)</span>

        <span class="c1"># go to freeze menu and back again to let</span>
        <span class="c1"># define create the correct default settings for &quot;freeze&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;freeze&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to freeze menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;frozen core / frozen virtual assignment menu*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;at free menu&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit freeze menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span>
        <span class="p">)</span>

        <span class="c1"># go to cbas menu and back again to let</span>
        <span class="c1"># define create the references to the auxiliary basis sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;cbas&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to cbas menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;AUXILIARY BASIS SET DEFINITION MENU*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;at cbas menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit cbas menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxcor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># set maximum core memory (maxcor)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;input memory&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;maxcor&quot;</span><span class="p">]),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;memory value&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;adc(2)&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex_mp2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;exci&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to excited states menu&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">irrep</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ex_mp2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">irrep_cmd</span> <span class="o">=</span> <span class="s2">&quot;irrep=</span><span class="si">{}</span><span class="s2"> multiplicity=</span><span class="si">{}</span><span class="s2"> nexc=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">irrep</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="n">irrep_cmd</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excited states&quot;</span><span class="p">)</span>
                    <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;unkown irrep&quot;</span><span class="p">,</span> <span class="s2">&quot;incomprehensible&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;irrep&quot;</span><span class="p">],</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set excited states&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                            <span class="s1">&#39;Error when providing the irrep &quot;</span><span class="si">{}</span><span class="s1">&quot; in ex_mp2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">irrep_cmd</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;spectrum  states=all&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set spectrum&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;exprop  states=all unrelaxed&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set exprop&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit excited states menu&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span>
                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_f12&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;f12&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;enter f12 menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;INPUT MENU FOR MP2-F12 CALCULATIONS&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;f12 menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit f12 menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;cabs&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to cabs menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;AUXILIARY BASIS SET DEFINITION MENU&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;at cabs menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit cabs menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Note: it seems that the line ccsdapprox ccsd(f12*) is already there</span>
            <span class="c1"># with just use_f12. This option is kept for safety.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_f12*&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ccsd(t)&quot;</span><span class="p">:</span>
                <span class="n">mdgo</span><span class="p">(</span><span class="s2">&quot;rir12&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ccsdapprox&quot;</span><span class="p">:</span> <span class="s2">&quot;ccsdapprox  ccsd(f12*)&quot;</span><span class="p">})</span>

        <span class="c1"># go to submenu &quot;ricc2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;ricc2&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to ricc2 menu&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy_only</span><span class="p">:</span>
            <span class="c1"># set mp2energy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set geopt mp2energy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;geoopt </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set method&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxiter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="s2">&quot;maxiter </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">]),</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set maximum iterations&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># go back to mp2 menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go back to mp2 menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;INPUT MENU FOR CALCULATIONS WITH ricc2*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to ricc2 options&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to general menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;GENERAL MENU.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to general menu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_switch_to_scf_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Go back to scf menu.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go back to scf menu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">([</span><span class="s2">&quot;ENTER SCF-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;at scf menu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_scf_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set all the options for scf.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_switch_to_scf_menu</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scfconv&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to conv menu&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER DESIRED ACCURACY OF SCF-ENERGY.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;at scf-energy menu&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scfconv&quot;</span><span class="p">]),</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set scfconv&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER SCF-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to scf menu&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scfiterlimit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;go to iter&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER NEW VALUE FOR MAXIMUM NUMBER OF SCF-ITERATIONS.*&quot;</span><span class="p">],</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;scf iterations&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scfiterlimit&quot;</span><span class="p">]),</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;insert maximum number of operations&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;ENTER SCF-OPTION TO BE MODIFIED.*&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;back to scf menu&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_go_to_general_menu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_quit_general_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quit the general menu, exiting from define.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendline</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;quit general menu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_mo_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the mos, alpha and beta files from a previous path.</span>

<span class="sd">        This uses the &quot;copymo&quot; path given in the parameters &quot;copymo&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if flag copymo - copy files (mos/alpha/beta) to current folder</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;copymo&quot;</span><span class="p">]:</span>

            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;copymo&quot;</span><span class="p">]</span>
            <span class="n">source_mos</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;mos&quot;</span><span class="p">)</span>
            <span class="n">source_alpha</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">)</span>
            <span class="n">source_beta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_mos</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_alpha</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_beta</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">DefineParameterError</span><span class="p">(</span>
                    <span class="s2">&quot;The files that should be copied do not exist&quot;</span>
                <span class="p">)</span>

            <span class="n">dest_mos</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;mos&quot;</span><span class="p">)</span>
            <span class="n">dest_alpha</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">)</span>
            <span class="n">dest_beta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">)</span>

            <span class="c1"># copy mos file from copymo dir to calculation dir if exist in both folders</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_mos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_mos</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_mos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="c1"># copy alpha and beta file from copymo dir to calculation dir if exist in</span>
            <span class="c1"># both folders</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_alpha</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_alpha</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_beta</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_beta</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

            <span class="c1"># manipulate mos file in copymo dir and save it to alpha and beta</span>
            <span class="c1"># if mos file in copymo dir an alpha/beta file in calculation dir</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_mos</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_alpha</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_beta</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_mos</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">new_alpha</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">new_beta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_alpha</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_alpha</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="s2">&quot;scfmo&quot;</span> <span class="ow">in</span> <span class="n">new_alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">new_alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;scfmo&quot;</span><span class="p">,</span> <span class="s2">&quot;uhfmo_alpha&quot;</span><span class="p">)</span>
                        <span class="n">new_beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;scfmo&quot;</span><span class="p">,</span> <span class="s2">&quot;uhfmo_beta&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_alpha</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">new_alpha</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_beta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">new_beta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_cosmo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add $cosmo datagroup based on the parameters available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cosmo_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">,</span> <span class="s2">&quot;nppa&quot;</span><span class="p">,</span> <span class="s2">&quot;nspa&quot;</span><span class="p">,</span> <span class="s2">&quot;disex&quot;</span><span class="p">,</span> <span class="s2">&quot;rsolv&quot;</span><span class="p">,</span> <span class="s2">&quot;routf&quot;</span><span class="p">,</span> <span class="s2">&quot;cavity&quot;</span><span class="p">]</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cosmo_keys</span><span class="p">}</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Control</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_cosmo</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add keywords to the control file that should be set outside define.</span>

<span class="sd">        This is typically used for:</span>
<span class="sd">            * cosmo</span>
<span class="sd">            * disp</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_cosmo&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_cosmo</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Control</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set_disp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;disp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DefineRunner.dump_command_file"><a class="viewcode-back" href="../../../api/turbomoleio.input.html#turbomoleio.input.define.DefineRunner.dump_command_file">[docs]</a>    <span class="k">def</span> <span class="nf">dump_command_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;define_commands&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump a file with the commands given to define.</span>

<span class="sd">        Can be used as an input for define to test its behavior:</span>
<span class="sd">        define &lt; define_commands</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: path to the file that should be written.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># add one file empty space to be sure of sending the last command</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sent_commands</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2022 BASF SE, Matgenix SRL

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>