

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>cerberus.validator &mdash; turbomoleio 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> turbomoleio
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../datagroups.html">The data group files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coord.html">The coord file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../definerunner.html">Running define</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output_parsing.html">Outputs parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendix</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developer/introduction.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/parsing_logs.html">Output logs parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/definerunner.html">Define runner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/versioning.html">Versioning</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bugs.html">Reporting bugs</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">turbomoleio</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>cerberus.validator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cerberus.validator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extensible validation for Python dictionaries.</span>
<span class="sd">    This module implements Cerberus Validator class</span>

<span class="sd">    :copyright: 2012-2016 by Nicola Iarocci.</span>
<span class="sd">    :license: ISC, see LICENSE for more details.</span>

<span class="sd">    Full documentation is available at http://python-cerberus.org</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">from</span> <span class="nn">cerberus</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">cerberus.platform</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_int_types</span><span class="p">,</span>
    <span class="n">_str_type</span><span class="p">,</span>
    <span class="n">Container</span><span class="p">,</span>
    <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Sized</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cerberus.schema</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">schema_registry</span><span class="p">,</span>
    <span class="n">rules_set_registry</span><span class="p">,</span>
    <span class="n">DefinitionSchema</span><span class="p">,</span>
    <span class="n">SchemaError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cerberus.utils</span> <span class="kn">import</span> <span class="n">drop_item_from_tuple</span><span class="p">,</span> <span class="n">readonly_classproperty</span><span class="p">,</span> <span class="n">TypeDefinition</span>

<span class="n">toy_error_handler</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">ToyErrorHandler</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">dummy_for_rule_validation</span><span class="p">(</span><span class="n">rule_constraints</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Dummy method called. Its purpose is to hold just&#39;</span>
            <span class="s1">&#39;validation constraints for a rule in its &#39;</span>
            <span class="s1">&#39;docstring.&#39;</span>
        <span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">dummy</span>
    <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">rule_constraints</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">class</span> <span class="nc">DocumentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Raised when the target document is missing or has the wrong format &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_SchemaRuleTypeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Raised when a schema (list) validation encounters a mapping.</span>
<span class="sd">        Not supposed to be used outside this module. &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">BareValidator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validator class. Normalizes and/or validates any mapping against a</span>
<span class="sd">    validation-schema which is provided as an argument at class instantiation</span>
<span class="sd">    or upon calling the :meth:`~cerberus.Validator.validate`,</span>
<span class="sd">    :meth:`~cerberus.Validator.validated` or</span>
<span class="sd">    :meth:`~cerberus.Validator.normalized` method. An instance itself is</span>
<span class="sd">    callable and executes a validation.</span>

<span class="sd">    All instantiation parameters are optional.</span>

<span class="sd">    There are the introspective properties :attr:`types`, :attr:`validators`,</span>
<span class="sd">    :attr:`coercers`, :attr:`default_setters`, :attr:`rules`,</span>
<span class="sd">    :attr:`normalization_rules` and :attr:`validation_rules`.</span>

<span class="sd">    The attributes reflecting the available rules are assembled considering</span>
<span class="sd">    constraints that are defined in the docstrings of rules&#39; methods and is</span>
<span class="sd">    effectively used as validation schema for :attr:`schema`.</span>

<span class="sd">    :param schema: See :attr:`~cerberus.Validator.schema`.</span>
<span class="sd">                   Defaults to :obj:`None`.</span>
<span class="sd">    :type schema: any :term:`mapping`</span>
<span class="sd">    :param ignore_none_values: See :attr:`~cerberus.Validator.ignore_none_values`.</span>
<span class="sd">                               Defaults to ``False``.</span>
<span class="sd">    :type ignore_none_values: :class:`bool`</span>
<span class="sd">    :param allow_unknown: See :attr:`~cerberus.Validator.allow_unknown`.</span>
<span class="sd">                          Defaults to ``False``.</span>
<span class="sd">    :type allow_unknown: :class:`bool` or any :term:`mapping`</span>
<span class="sd">    :param require_all: See :attr:`~cerberus.Validator.require_all`.</span>
<span class="sd">                        Defaults to ``False``.</span>
<span class="sd">    :type require_all: :class:`bool`</span>
<span class="sd">    :param purge_unknown: See :attr:`~cerberus.Validator.purge_unknown`.</span>
<span class="sd">                          Defaults to to ``False``.</span>
<span class="sd">    :type purge_unknown: :class:`bool`</span>
<span class="sd">    :param purge_readonly: Removes all fields that are defined as ``readonly`` in the</span>
<span class="sd">                           normalization phase.</span>
<span class="sd">    :type purge_readonly: :class:`bool`</span>
<span class="sd">    :param error_handler: The error handler that formats the result of</span>
<span class="sd">                          :attr:`~cerberus.Validator.errors`.</span>
<span class="sd">                          When given as two-value tuple with an error-handler</span>
<span class="sd">                          class and a dictionary, the latter is passed to the</span>
<span class="sd">                          initialization of the error handler.</span>
<span class="sd">                          Default: :class:`~cerberus.errors.BasicErrorHandler`.</span>
<span class="sd">    :type error_handler: class or instance based on</span>
<span class="sd">                         :class:`~cerberus.errors.BaseErrorHandler` or</span>
<span class="sd">                         :class:`tuple`</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="n">mandatory_validations</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,)</span>
    <span class="sd">&quot;&quot;&quot; Rules that are evaluated on any field, regardless whether defined in</span>
<span class="sd">        the schema or not.</span>
<span class="sd">        Type: :class:`tuple` &quot;&quot;&quot;</span>
    <span class="n">priority_validations</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;empty&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot; Rules that will be processed in that order before any other.</span>
<span class="sd">        Type: :class:`tuple` &quot;&quot;&quot;</span>
    <span class="n">types_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">),</span> <span class="p">()),</span>
        <span class="s1">&#39;boolean&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;container&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;container&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Container</span><span class="p">,),</span> <span class="p">(</span><span class="n">_str_type</span><span class="p">,)),</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Mapping</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">_int_types</span><span class="p">),</span> <span class="p">()),</span>
        <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">_int_types</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Sequence</span><span class="p">,),</span> <span class="p">(</span><span class="n">_str_type</span><span class="p">,)),</span>
        <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">_int_types</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,)),</span>
        <span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,),</span> <span class="p">()),</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="n">TypeDefinition</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">_str_type</span><span class="p">),</span> <span class="p">()),</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot; This mapping holds all available constraints for the type rule and</span>
<span class="sd">        their assigned :class:`~cerberus.TypeDefinition`. &quot;&quot;&quot;</span>
    <span class="n">_valid_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot; A :class:`set` of hashes derived from validation schemas that are</span>
<span class="sd">        legit for a particular ``Validator`` class. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The arguments will be treated as with this signature:</span>

<span class="sd">        __init__(self, schema=None, ignore_none_values=False,</span>
<span class="sd">                 allow_unknown=False, require_all=False,</span>
<span class="sd">                 purge_unknown=False, purge_readonly=False,</span>
<span class="sd">                 error_handler=errors.BasicErrorHandler)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot; The document that is or was recently processed.</span>
<span class="sd">            Type: any :term:`mapping` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">ErrorList</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; The list of errors that were encountered since the last document</span>
<span class="sd">            processing was invoked.</span>
<span class="sd">            Type: :class:`~cerberus.errors.ErrorList` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recent_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot; The last individual error that was submitted.</span>
<span class="sd">            Type: :class:`~cerberus.errors.ValidationError` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">DocumentErrorTree</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; A tree representiation of encountered errors following the</span>
<span class="sd">            structure of the document.</span>
<span class="sd">            Type: :class:`~cerberus.errors.DocumentErrorTree` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_error_tree</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">SchemaErrorTree</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; A tree representiation of encountered errors following the</span>
<span class="sd">            structure of the schema.</span>
<span class="sd">            Type: :class:`~cerberus.errors.SchemaErrorTree` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">=</span> <span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; The path within the document to the current sub-document.</span>
<span class="sd">            Type: :class:`tuple` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">=</span> <span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; The path within the schema to the current sub-schema.</span>
<span class="sd">            Type: :class:`tuple` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_error_handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot; The error handler used to format :attr:`~cerberus.Validator.errors`</span>
<span class="sd">            and process submitted errors with</span>
<span class="sd">            :meth:`~cerberus.Validator._error`.</span>
<span class="sd">            Type: :class:`~cerberus.errors.BaseErrorHandler` &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__store_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot; Keeps track of the rules that are next in line to be evaluated</span>
<span class="sd">            during the validation of a field.</span>
<span class="sd">            Type: :class:`list` &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BareValidator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__init_error_handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">error_handler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;error_handler&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BasicErrorHandler</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_handler</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">error_handler</span><span class="p">,</span> <span class="n">eh_config</span> <span class="o">=</span> <span class="n">error_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eh_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_handler</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
            <span class="n">error_handler</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BaseErrorHandler</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">error_handler</span><span class="p">(</span><span class="o">**</span><span class="n">eh_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_handler</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BaseErrorHandler</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">error_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid error_handler.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__store_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assign args to kwargs and store configuration. &quot;&quot;&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;schema&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ignore_none_values&#39;</span><span class="p">,</span>
            <span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span>
            <span class="s1">&#39;require_all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;purge_unknown&#39;</span><span class="p">,</span>
            <span class="s1">&#39;purge_readonly&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signature</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)]):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;__init__ got multiple values for argument &quot;</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="sd">&quot;&quot;&quot; This dictionary holds the configuration arguments that were used to</span>
<span class="sd">            initialize the :class:`Validator` instance except the</span>
<span class="sd">            ``error_handler``. &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Purge the cache of known valid schemas. &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_valid_schemas</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates and adds one or multiple errors.</span>

<span class="sd">        :param args: Accepts different argument&#39;s signatures.</span>

<span class="sd">                     *1. Bulk addition of errors:*</span>

<span class="sd">                     - :term:`iterable` of</span>
<span class="sd">                       :class:`~cerberus.errors.ValidationError`-instances</span>

<span class="sd">                     The errors will be added to</span>
<span class="sd">                     :attr:`~cerberus.Validator._errors`.</span>

<span class="sd">                     *2. Custom error:*</span>

<span class="sd">                     - the invalid field&#39;s name</span>

<span class="sd">                     - the error message</span>

<span class="sd">                     A custom error containing the message will be created and</span>
<span class="sd">                     added to :attr:`~cerberus.Validator._errors`.</span>
<span class="sd">                     There will however be fewer information contained in the</span>
<span class="sd">                     error (no reference to the violated rule and its</span>
<span class="sd">                     constraint).</span>

<span class="sd">                     *3. Defined error:*</span>

<span class="sd">                     - the invalid field&#39;s name</span>

<span class="sd">                     - the error-reference, see :mod:`cerberus.errors`</span>

<span class="sd">                     - arbitrary, supplemental information about the error</span>

<span class="sd">                     A :class:`~cerberus.errors.ValidationError` instance will</span>
<span class="sd">                     be created and added to</span>
<span class="sd">                     :attr:`~cerberus.Validator._errors`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schema_error_tree</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">errors</span><span class="o">.</span><span class="n">CUSTOM</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">code</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rule</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

            <span class="n">document_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">+</span> <span class="p">(</span><span class="n">field</span><span class="p">,)</span>

            <span class="n">schema_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">errors</span><span class="o">.</span><span class="n">UNKNOWN_FIELD</span><span class="o">.</span><span class="n">code</span> <span class="ow">and</span> <span class="n">rule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">schema_path</span> <span class="o">+=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">constraint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_rules_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">field_definitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">field_definitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_definitions</span><span class="p">:</span>
                        <span class="n">schema_path</span> <span class="o">=</span> <span class="s2">&quot;__require_all__&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">field_definitions</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span>

            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">recent_error</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="n">document_path</span><span class="p">,</span> <span class="n">schema_path</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">info</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">recent_error</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_get_child_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_crumb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema_crumb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a new instance of Validator-(sub-)class. All initial</span>
<span class="sd">            parameters of the parent are passed to the initialization, unless</span>
<span class="sd">            a parameter is given as an explicit *keyword*-parameter.</span>

<span class="sd">        :param document_crumb: Extends the</span>
<span class="sd">                               :attr:`~cerberus.Validator.document_path`</span>
<span class="sd">                               of the child-validator.</span>
<span class="sd">        :type document_crumb: :class:`tuple` or :term:`hashable`</span>
<span class="sd">        :param schema_crumb: Extends the</span>
<span class="sd">                             :attr:`~cerberus.Validator.schema_path`</span>
<span class="sd">                             of the child-validator.</span>
<span class="sd">        :type schema_crumb: :class:`tuple` or hashable</span>
<span class="sd">        :param kwargs: Overriding keyword-arguments for initialization.</span>
<span class="sd">        :type kwargs: :class:`dict`</span>

<span class="sd">        :return: an instance of ``self.__class__``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">child_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">child_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child</span><span class="p">:</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;is_child&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;error_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">toy_error_handler</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;root_allow_unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;root_require_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;root_document&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>
            <span class="n">child_config</span><span class="p">[</span><span class="s1">&#39;root_schema&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

        <span class="n">child_validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">child_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">document_crumb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">child_validator</span><span class="o">.</span><span class="n">document_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">document_crumb</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">document_crumb</span> <span class="o">=</span> <span class="p">(</span><span class="n">document_crumb</span><span class="p">,)</span>
            <span class="n">child_validator</span><span class="o">.</span><span class="n">document_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">+</span> <span class="n">document_crumb</span>

        <span class="k">if</span> <span class="n">schema_crumb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">child_validator</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema_crumb</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">schema_crumb</span> <span class="o">=</span> <span class="p">(</span><span class="n">schema_crumb</span><span class="p">,)</span>
            <span class="n">child_validator</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">+</span> <span class="n">schema_crumb</span>

        <span class="k">return</span> <span class="n">child_validator</span>

    <span class="k">def</span> <span class="nf">__get_rule_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">methodname</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;There&#39;s no handler for &#39;</span><span class="si">{}</span><span class="s2">&#39; in the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;domain.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">dp_items</span><span class="p">,</span> <span class="n">sp_items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes nodes by index from an errorpath, relatively to the</span>
<span class="sd">            basepaths of self.</span>

<span class="sd">        :param errors: A list of :class:`errors.ValidationError` instances.</span>
<span class="sd">        :param dp_items: A list of integers, pointing at the nodes to drop from</span>
<span class="sd">                         the :attr:`document_path`.</span>
<span class="sd">        :param sp_items: Alike ``dp_items``, but for :attr:`schema_path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dp_basedepth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document_path</span><span class="p">)</span>
        <span class="n">sp_basedepth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">_errors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dp_items</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">error</span><span class="o">.</span><span class="n">document_path</span> <span class="o">=</span> <span class="n">drop_item_from_tuple</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">document_path</span><span class="p">,</span> <span class="n">dp_basedepth</span> <span class="o">+</span> <span class="n">i</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sp_items</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">error</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">=</span> <span class="n">drop_item_from_tuple</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">schema_path</span><span class="p">,</span> <span class="n">sp_basedepth</span> <span class="o">+</span> <span class="n">i</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">child_errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">child_errors</span><span class="p">,</span> <span class="n">dp_items</span><span class="p">,</span> <span class="n">sp_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lookup_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Searches for a field as defined by path. This method is used by the</span>
<span class="sd">            ``dependency`` evaluation logic.</span>

<span class="sd">        :param path: Path elements are separated by a ``.``. A leading ``^``</span>
<span class="sd">                     indicates that the path relates to the document root,</span>
<span class="sd">                     otherwise it relates to the currently evaluated document,</span>
<span class="sd">                     which is possibly a subdocument.</span>
<span class="sd">                     The sequence ``^^`` at the start will be interpreted as a</span>
<span class="sd">                     literal ``^``.</span>
<span class="sd">        :type path: :class:`str`</span>
<span class="sd">        :returns: Either the found field name and its value or :obj:`None` for</span>
<span class="sd">                  both.</span>
<span class="sd">        :rtype: A two-value :class:`tuple`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_document</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">context</span>

    <span class="k">def</span> <span class="nf">_resolve_rules_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_set</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules_set</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rules_set</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules_set</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_set_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rules_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_resolve_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">schema</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allow_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``True`` unknown fields that are not defined in the schema will</span>
<span class="sd">            be ignored. If a mapping with a validation schema is given, any</span>
<span class="sd">            undefined field will be validated against its rules.</span>
<span class="sd">            Also see :ref:`allowing-the-unknown`.</span>
<span class="sd">            Type: :class:`bool` or any :term:`mapping` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@allow_unknown</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">allow_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_child</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">DefinitionSchema</span><span class="p">))):</span>
            <span class="n">DefinitionSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">require_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``True`` known fields that are defined in the schema will</span>
<span class="sd">            be required.</span>
<span class="sd">            Type: :class:`bool` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@require_all</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">require_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;require_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The errors of the last processing formatted by the handler that is</span>
<span class="sd">            bound to :attr:`~cerberus.Validator.error_handler`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ignore_none_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether to not process :obj:`None`-values in a document or not.</span>
<span class="sd">            Type: :class:`bool` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignore_none_values&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@ignore_none_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ignore_none_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;ignore_none_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_child</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ``True`` for child-validators obtained with</span>
<span class="sd">        :meth:`~cerberus.Validator._get_child_validator`.</span>
<span class="sd">        Type: :class:`bool` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_child&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ``True`` if the document is already normalized. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_is_normalized&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@_is_normalized</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_is_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;_is_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purge_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``True``, unknown fields will be deleted from the document</span>
<span class="sd">            unless a validation is called with disabled normalization.</span>
<span class="sd">            Also see :ref:`purging-unknown-fields`. Type: :class:`bool` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;purge_unknown&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@purge_unknown</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">purge_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;purge_unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purge_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``True``, fields declared as readonly will be deleted from the</span>
<span class="sd">            document unless a validation is called with disabled normalization.</span>
<span class="sd">            Type: :class:`bool` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;purge_readonly&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@purge_readonly</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">purge_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;purge_readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_allow_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :attr:`~cerberus.Validator.allow_unknown` attribute of the</span>
<span class="sd">            first level ancestor of a child validator. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_allow_unknown&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_require_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :attr:`~cerberus.Validator.require_all` attribute of</span>
<span class="sd">            the first level ancestor of a child validator. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_require_all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :attr:`~cerberus.Validator.document` attribute of the</span>
<span class="sd">            first level ancestor of a child validator. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_document&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rules_set_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The registry that holds referenced rules sets.</span>
<span class="sd">            Type: :class:`~cerberus.Registry` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules_set_registry&#39;</span><span class="p">,</span> <span class="n">rules_set_registry</span><span class="p">)</span>

    <span class="nd">@rules_set_registry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rules_set_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;rules_set_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :attr:`~cerberus.Validator.schema` attribute of the</span>
<span class="sd">            first level ancestor of a child validator. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_schema&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The validation schema of a validator. When a schema is passed to</span>
<span class="sd">            a method, it replaces this attribute.</span>
<span class="sd">            Type: any :term:`mapping` or :obj:`None` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="nd">@schema</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">DefinitionSchema</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">DefinitionSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The registry that holds referenced schemas.</span>
<span class="sd">            Type: :class:`~cerberus.Registry` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_registry&#39;</span><span class="p">,</span> <span class="n">schema_registry</span><span class="p">)</span>

    <span class="nd">@schema_registry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">schema_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;schema_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="c1"># FIXME the returned method has the correct docstring, but doesn&#39;t appear</span>
    <span class="c1">#       in the API docs</span>
    <span class="nd">@readonly_classproperty</span>
    <span class="k">def</span> <span class="nf">types</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The constraints that can be used for the &#39;type&#39; rule.</span>
<span class="sd">            Type: A tuple of strings. &quot;&quot;&quot;</span>
        <span class="n">redundant_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">types_mapping</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_types_from_methods</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redundant_types</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;These types are defined both with a method and in the&quot;</span>
                <span class="s2">&quot;&#39;types_mapping&#39; property of this validator: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">redundant_types</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">types_mapping</span><span class="p">)</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_types_from_methods</span>

    <span class="c1"># Document processing</span>

    <span class="k">def</span> <span class="nf">__init_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">ErrorList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recent_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">DocumentErrorTree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_error_tree</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">SchemaErrorTree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_normalized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">DefinitionSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">SCHEMA_ERROR_MISSING</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">document</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DocumentError</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">DOCUMENT_MISSING</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DocumentError</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">DOCUMENT_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_remaining_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rules</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drops rules from the queue of the rules that still need to be</span>
<span class="sd">            evaluated for the currently processed field.</span>
<span class="sd">            If no arguments are given, the whole queue is emptied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># # Normalizing</span>

    <span class="k">def</span> <span class="nf">normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the document normalized according to the specified rules</span>
<span class="sd">        of a schema.</span>

<span class="sd">        :param document: The document to normalize.</span>
<span class="sd">        :type document: any :term:`mapping`</span>
<span class="sd">        :param schema: The validation schema. Defaults to :obj:`None`. If not</span>
<span class="sd">                       provided here, the schema must have been provided at</span>
<span class="sd">                       class instantiation.</span>
<span class="sd">        :type schema: any :term:`mapping`</span>
<span class="sd">        :param always_return_document: Return the document, even if an error</span>
<span class="sd">                                       occurred. Defaults to: ``False``.</span>
<span class="sd">        :type always_return_document: :class:`bool`</span>
<span class="sd">        :return: A normalized copy of the provided mapping or :obj:`None` if an</span>
<span class="sd">                 error occurred during normalization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_processing</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_document</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>

    <span class="k">def</span> <span class="nf">__normalize_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_rules_set</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_rename_fields</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_unknown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_purge_unknown</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_purge_readonly</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="c1"># Check `readonly` fields before applying default values because</span>
        <span class="c1"># a field&#39;s schema definition might contain both `readonly` and</span>
        <span class="c1"># `default`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_readonly_fields</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_default_fields</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_coerce</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_containers</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_normalized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">_normalize_coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;oneof&#39;: [</span>
<span class="sd">                {&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                {&#39;type&#39;: &#39;list&#39;,</span>
<span class="sd">                 &#39;schema&#39;: {&#39;oneof&#39;: [{&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                                      {&#39;type&#39;: &#39;string&#39;}]}},</span>
<span class="sd">                {&#39;type&#39;: &#39;string&#39;}</span>
<span class="sd">                ]} &quot;&quot;&quot;</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">COERCION_FAILED</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span> <span class="ow">and</span> <span class="s1">&#39;coerce&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_coerce</span><span class="p">(</span>
                    <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;coerce&#39;</span><span class="p">],</span>
                    <span class="n">field</span><span class="p">,</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                    <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">error</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s1">&#39;coerce&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>
            <span class="p">):</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_coerce</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">[</span><span class="s1">&#39;coerce&#39;</span><span class="p">],</span>
                    <span class="n">field</span><span class="p">,</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">error</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__normalize_coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nullable</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="n">processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;normalize_coerce&#39;</span><span class="p">,</span> <span class="n">processor</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processor</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_coerce</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">nullable</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">COERCION_FAILED</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span><span class="o">.</span><span class="n">fetch_errors_from</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">+</span> <span class="p">(</span><span class="n">field</span><span class="p">,)</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">processor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nullable</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__normalize_containers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">()))</span>

            <span class="c1"># TODO: This check conflates validation and normalization</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;keysrules&#39;</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_mapping_per_keysrules</span><span class="p">(</span>
                        <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;keysrules&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;valuesrules&#39;</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_mapping_per_valuesrules</span><span class="p">(</span>
                        <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;valuesrules&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">rules</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;purge_unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">)</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_mapping_per_schema</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">_SchemaRuleTypeError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">_str_type</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;schema&#39;</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_sequence_per_schema</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_sequence_per_items</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__normalize_mapping_per_keysrules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">property_rules</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">property_rules</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
        <span class="n">document</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;keysrules&#39;</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Normalizing keys of </span><span class="si">{path}</span><span class="s2">: </span><span class="si">{key}</span><span class="s2"> already exists, &quot;</span>
                    <span class="s2">&quot;its value is replaced.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">+</span> <span class="p">(</span><span class="n">field</span><span class="p">,)),</span>
                        <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__normalize_mapping_per_valuesrules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">value_rules</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">value_rules</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;valuesrules&#39;</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span>
        <span class="p">)</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__normalize_mapping_per_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
            <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">allow_unknown</span><span class="o">=</span><span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">),</span>  <span class="c1"># noqa: E501</span>
            <span class="n">purge_unknown</span><span class="o">=</span><span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;purge_unknown&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_unknown</span><span class="p">),</span>
            <span class="n">require_all</span><span class="o">=</span><span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">),</span>
        <span class="p">)</span>  <span class="c1"># noqa: E501</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">result_value</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__normalize_sequence_per_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;schema&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">])))</span>
        <span class="p">)</span>
        <span class="n">document</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span>
        <span class="p">)</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__normalize_sequence_per_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">rules</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules</span><span class="p">)))</span>
        <span class="n">document</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span>
        <span class="p">)</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">always_return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__normalize_purge_readonly</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]:</span>
            <span class="n">mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normalize_purge_unknown</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">]:</span>
            <span class="n">mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">__normalize_rename_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">mapping</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_rename</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_rename_handler</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s1">&#39;rename_handler&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_rename_handler</span><span class="p">(</span>
                    <span class="n">mapping</span><span class="p">,</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">},</span> <span class="n">field</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">_normalize_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;hashable&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_normalize_rename_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;oneof&#39;: [</span>
<span class="sd">                {&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                {&#39;type&#39;: &#39;list&#39;,</span>
<span class="sd">                 &#39;schema&#39;: {&#39;oneof&#39;: [{&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                                      {&#39;type&#39;: &#39;string&#39;}]}},</span>
<span class="sd">                {&#39;type&#39;: &#39;string&#39;}</span>
<span class="sd">                ]} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;rename_handler&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_coerce</span><span class="p">(</span>
            <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;rename_handler&#39;</span><span class="p">],</span> <span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">RENAMING_FAILED</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__validate_readonly_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">schema</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_rules_set</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_readonly</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;readonly&#39;</span><span class="p">],</span> <span class="n">field</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__normalize_default_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">empty_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">schema</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># noqa: W503</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># noqa: W503</span>
        <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fields_with_default</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">empty_fields</span> <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_SchemaRuleTypeError</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_with_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_default</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="n">known_fields_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">fields_with_default_setter</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">empty_fields</span> <span class="k">if</span> <span class="s1">&#39;default_setter&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">while</span> <span class="n">fields_with_default_setter</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">fields_with_default_setter</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_default_setter</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">fields_with_default_setter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">SETTING_DEFAULT_FAILED</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="n">fields_processing_state</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fields_with_default_setter</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fields_processing_state</span> <span class="ow">in</span> <span class="n">known_fields_states</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_with_default_setter</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span>
                        <span class="n">field</span><span class="p">,</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">SETTING_DEFAULT_FAILED</span><span class="p">,</span>
                        <span class="s1">&#39;Circular dependencies of default setters.&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">known_fields_states</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fields_processing_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;nullable&#39;: True} &quot;&quot;&quot;</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_normalize_default_setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;oneof&#39;: [</span>
<span class="sd">                {&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                {&#39;type&#39;: &#39;string&#39;}</span>
<span class="sd">                ]} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;default_setter&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;default_setter&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setter</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
                <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;normalize_default_setter&#39;</span><span class="p">,</span> <span class="n">setter</span><span class="p">)</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">setter</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

    <span class="c1"># # Validating</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Normalizes and validates a mapping against a validation-schema of</span>
<span class="sd">        defined rules.</span>

<span class="sd">        :param document: The document to normalize.</span>
<span class="sd">        :type document: any :term:`mapping`</span>
<span class="sd">        :param schema: The validation schema. Defaults to :obj:`None`. If not</span>
<span class="sd">                       provided here, the schema must have been provided at</span>
<span class="sd">                       class instantiation.</span>
<span class="sd">        :type schema: any :term:`mapping`</span>
<span class="sd">        :param update: If ``True``, required fields won&#39;t be checked.</span>
<span class="sd">        :type update: :class:`bool`</span>
<span class="sd">        :param normalize: If ``True``, normalize the document before validation.</span>
<span class="sd">        :type normalize: :class:`bool`</span>

<span class="sd">        :return: ``True`` if validation succeeds, otherwise ``False``. Check</span>
<span class="sd">                 the :func:`errors` property for a list of processing errors.</span>
<span class="sd">        :rtype: :class:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="n">update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__init_processing</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__normalize_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_none_values</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">definitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__validate_definitions</span><span class="p">(</span><span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__validate_unknown_fields</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_required_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">validate</span>

    <span class="k">def</span> <span class="nf">validated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wrapper around :meth:`~cerberus.Validator.validate` that returns</span>
<span class="sd">            the normalized and validated document or :obj:`None` if validation</span>
<span class="sd">            failed. &quot;&quot;&quot;</span>
        <span class="n">always_return_document</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;always_return_document&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_document</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>

    <span class="k">def</span> <span class="nf">__validate_unknown_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="p">(</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">)):</span>
                <span class="c1"># validate that unknown fields matches the schema</span>
                <span class="c1"># for unknown_fields</span>
                <span class="n">schema_crumb</span> <span class="o">=</span> <span class="s1">&#39;allow_unknown&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child</span> <span class="k">else</span> <span class="s1">&#39;__allow_unknown__&#39;</span>
                <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
                    <span class="n">schema_crumb</span><span class="o">=</span><span class="n">schema_crumb</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UNKNOWN_FIELD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validate a field&#39;s value against its defined rules. &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">validate_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">validator</span><span class="p">(</span><span class="n">definitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_rules_set</span><span class="p">(</span><span class="n">definitions</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="n">rules_queue</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_validations</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">definitions</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_validations</span>
        <span class="p">]</span>
        <span class="n">rules_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_validations</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rules_queue</span>
        <span class="p">)</span>
        <span class="n">rules_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">definitions</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rules_queue</span>
            <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_rules</span>
            <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;require_all&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span> <span class="o">=</span> <span class="n">rules_queue</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_rules</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">validate_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
                <span class="c1"># TODO remove on next breaking release</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="n">_SchemaRuleTypeError</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_remaining_rules</span><span class="p">()</span>

    <span class="c1"># Remember to keep the validation methods below this line</span>
    <span class="c1"># sorted alphabetically</span>

    <span class="n">_validate_allow_unknown</span> <span class="o">=</span> <span class="n">dummy_for_rule_validation</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot; {&#39;oneof&#39;: [{&#39;type&#39;: &#39;boolean&#39;},</span>
<span class="sd">                       {&#39;type&#39;: [&#39;dict&#39;, &#39;string&#39;],</span>
<span class="sd">                        &#39;check_with&#39;: &#39;bulk_schema&#39;}]} &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allowed_values</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;container&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="n">unallowed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unallowed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UNALLOWED_VALUES</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">unallowed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UNALLOWED_VALUE</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_check_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;oneof&#39;: [</span>
<span class="sd">                {&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                {&#39;type&#39;: &#39;list&#39;,</span>
<span class="sd">                 &#39;schema&#39;: {&#39;oneof&#39;: [{&#39;type&#39;: &#39;callable&#39;},</span>
<span class="sd">                                      {&#39;type&#39;: &#39;string&#39;}]}},</span>
<span class="sd">                {&#39;type&#39;: &#39;string&#39;}</span>
<span class="sd">                ]} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checks</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value_checker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;check_with&#39;</span><span class="p">,</span> <span class="n">checks</span><span class="p">)</span>
            <span class="c1"># TODO remove on next major release</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">value_checker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">,</span> <span class="n">checks</span><span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;validator&#39; rule was renamed to &#39;check_with&#39;. Please update &quot;</span>
                    <span class="s2">&quot;your schema and method names accordingly.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">value_checker</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checks</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_check_with</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_values</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;empty&#39;: False } &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">expected_values</span><span class="p">,</span> <span class="n">_str_type</span>
        <span class="p">):</span>
            <span class="n">expected_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">expected_values</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expected_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>

        <span class="n">missing_values</span> <span class="o">=</span> <span class="n">expected_values</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MISSING_MEMBERS</span><span class="p">,</span> <span class="n">missing_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: (&#39;dict&#39;, &#39;hashable&#39;, &#39;list&#39;),</span>
<span class="sd">             &#39;check_with&#39;: &#39;dependencies&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">dependencies</span><span class="p">,</span> <span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">(</span><span class="n">dependencies</span><span class="p">,)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_dependencies_sequence</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_dependencies_mapping</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span><span class="o">.</span><span class="n">fetch_node_from</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span> <span class="o">+</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__validate_dependencies_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">validated_dependencies_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dependency_name</span><span class="p">,</span> <span class="n">dependency_values</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependency_values</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">dependency_values</span><span class="p">,</span> <span class="n">_str_type</span>
            <span class="p">):</span>
                <span class="n">dependency_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">dependency_values</span><span class="p">]</span>

            <span class="n">wanted_field</span><span class="p">,</span> <span class="n">wanted_field_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_field</span><span class="p">(</span><span class="n">dependency_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wanted_field_value</span> <span class="ow">in</span> <span class="n">dependency_values</span><span class="p">:</span>
                <span class="n">validated_dependencies_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dependency_name</span><span class="p">:</span> <span class="n">wanted_field_value</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">validated_dependencies_counter</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">DEPENDENCIES_FIELD_VALUE</span><span class="p">,</span> <span class="n">error_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_dependencies_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_field</span><span class="p">(</span><span class="n">dependency</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">DEPENDENCIES_FIELD</span><span class="p">,</span> <span class="n">dependency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Sized</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_remaining_rules</span><span class="p">(</span>
                <span class="s1">&#39;allowed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;forbidden&#39;</span><span class="p">,</span>
                <span class="s1">&#39;items&#39;</span><span class="p">,</span>
                <span class="s1">&#39;minlength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;maxlength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;regex&#39;</span><span class="p">,</span>
                <span class="s1">&#39;check_with&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">EMPTY_NOT_ALLOWED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_excludes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excluded_fields</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: (&#39;hashable&#39;, &#39;list&#39;),</span>
<span class="sd">             &#39;schema&#39;: {&#39;type&#39;: &#39;hashable&#39;}} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">excluded_fields</span><span class="p">,</span> <span class="n">Hashable</span><span class="p">):</span>
            <span class="n">excluded_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">excluded_fields</span><span class="p">]</span>

        <span class="c1"># Mark the currently evaluated field as not required for now if it actually is.</span>
        <span class="c1"># One of the so marked will be needed to pass when required fields are checked.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">excluded_field</span> <span class="ow">in</span> <span class="n">excluded_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">excluded_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span>
            <span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">excluded_field</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">excluded_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="k">for</span> <span class="n">excluded_field</span> <span class="ow">in</span> <span class="n">excluded_fields</span><span class="p">):</span>
            <span class="n">exclusion_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">excluded_fields</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">EXCLUDES_FIELD</span><span class="p">,</span> <span class="n">exclusion_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_forbidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forbidden_values</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="n">forbidden</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">forbidden_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">forbidden</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">FORBIDDEN_VALUES</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">forbidden</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">forbidden_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">FORBIDDEN_VALUE</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;, &#39;check_with&#39;: &#39;items&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">ITEMS_LENGTH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># noqa: E501</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
                <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">),</span>  <span class="c1"># noqa: E501</span>
                <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BAD_ITEMS</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_logical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates value against all definitions and logs errors according</span>
<span class="sd">            to the operator. &quot;&quot;&quot;</span>
        <span class="n">valid_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">ErrorList</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">definitions</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">definition</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                    <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">rule</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;allow_unknown&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>

            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
                <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">validator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">valid_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">_errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">valid_counter</span><span class="p">,</span> <span class="n">_errors</span>

    <span class="k">def</span> <span class="nf">_validate_anyof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;, &#39;logical&#39;: &#39;anyof&#39;} &quot;&quot;&quot;</span>
        <span class="n">valids</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_logical</span><span class="p">(</span><span class="s1">&#39;anyof&#39;</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valids</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">ANYOF</span><span class="p">,</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">definitions</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_allof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;, &#39;logical&#39;: &#39;allof&#39;} &quot;&quot;&quot;</span>
        <span class="n">valids</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_logical</span><span class="p">(</span><span class="s1">&#39;allof&#39;</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valids</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">definitions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">ALLOF</span><span class="p">,</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">definitions</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_noneof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;, &#39;logical&#39;: &#39;noneof&#39;} &quot;&quot;&quot;</span>
        <span class="n">valids</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_logical</span><span class="p">(</span><span class="s1">&#39;noneof&#39;</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">NONEOF</span><span class="p">,</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">definitions</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_oneof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;list&#39;, &#39;logical&#39;: &#39;oneof&#39;} &quot;&quot;&quot;</span>
        <span class="n">valids</span><span class="p">,</span> <span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_logical</span><span class="p">(</span><span class="s1">&#39;oneof&#39;</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valids</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">ONEOF</span><span class="p">,</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">definitions</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;nullable&#39;: False } &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MAX_VALUE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_validate_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;nullable&#39;: False } &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MIN_VALUE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_validate_maxlength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;integer&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="n">_validate_meta</span> <span class="o">=</span> <span class="n">dummy_for_rule_validation</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_minlength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;integer&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MIN_LENGTH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nullable</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nullable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">NOT_NULLABLE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_remaining_rules</span><span class="p">(</span>
                <span class="s1">&#39;allowed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;empty&#39;</span><span class="p">,</span>
                <span class="s1">&#39;forbidden&#39;</span><span class="p">,</span>
                <span class="s1">&#39;items&#39;</span><span class="p">,</span>
                <span class="s1">&#39;keysrules&#39;</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">,</span>
                <span class="s1">&#39;minlength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;maxlength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;regex&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schema&#39;</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">,</span>
                <span class="s1">&#39;valuesrules&#39;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_keysrules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: [&#39;dict&#39;, &#39;string&#39;], &#39;check_with&#39;: &#39;bulk_schema&#39;,</span>
<span class="sd">            &#39;forbidden&#39;: [&#39;rename&#39;, &#39;rename_handler&#39;]} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
                <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;keysrules&#39;</span><span class="p">),</span>
                <span class="n">schema</span><span class="o">=</span><span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">KEYSRULES</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_normalized</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">READONLY_FIELD</span><span class="p">)</span>
            <span class="c1"># If the document was normalized (and therefore already been</span>
            <span class="c1"># checked for readonly fields), we still have to return True</span>
            <span class="c1"># if an error was filed.</span>
            <span class="n">has_error</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">READONLY_FIELD</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_error_tree</span><span class="o">.</span><span class="n">fetch_errors_from</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">document_path</span> <span class="o">+</span> <span class="p">(</span><span class="n">field</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_normalized</span> <span class="ow">and</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drop_remaining_rules</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: &#39;string&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">+=</span> <span class="s1">&#39;$&#39;</span>
        <span class="n">re_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re_obj</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">REGEX_MISMATCH</span><span class="p">)</span>

    <span class="n">_validate_required</span> <span class="o">=</span> <span class="n">dummy_for_rule_validation</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">_validate_require_all</span> <span class="o">=</span> <span class="n">dummy_for_rule_validation</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; {&#39;type&#39;: &#39;boolean&#39;} &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_required_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates that required fields are not missing.</span>

<span class="sd">        :param document: The document being validated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_rules_set</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">)</span>
                <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;schema&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_SchemaRuleTypeError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="n">required</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span>
            <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_none_values</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">REQUIRED_FIELD</span><span class="p">)</span>

        <span class="c1"># At least one field from self._unrequired_by_excludes should be present in</span>
        <span class="c1"># document.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span> <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unrequired_by_excludes</span> <span class="o">-</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">REQUIRED_FIELD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: [&#39;dict&#39;, &#39;string&#39;],</span>
<span class="sd">             &#39;anyof&#39;: [{&#39;check_with&#39;: &#39;schema&#39;},</span>
<span class="sd">                       {&#39;check_with&#39;: &#39;bulk_schema&#39;}]} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_schema_sequence</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_schema_mapping</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_schema_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">allow_unknown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_unknown&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">)</span>
        <span class="n">require_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_all</span><span class="p">)</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
            <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">allow_unknown</span><span class="o">=</span><span class="n">allow_unknown</span><span class="p">,</span>
            <span class="n">require_all</span><span class="o">=</span><span class="n">require_all</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MAPPING_SCHEMA</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_SchemaRuleTypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BAD_TYPE_FOR_SCHEMA</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__validate_schema_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">i</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))))</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
            <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
            <span class="n">schema_crumb</span><span class="o">=</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">allow_unknown</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">validator</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(((</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">))),</span>
            <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
            <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">SEQUENCE_SCHEMA</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: [&#39;string&#39;, &#39;list&#39;],</span>
<span class="sd">             &#39;check_with&#39;: &#39;type&#39;} &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_type</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_type</span><span class="p">,)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">_str_type</span><span class="p">)</span> <span class="k">else</span> <span class="n">data_type</span>

        <span class="k">for</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="c1"># TODO remove this block on next major release</span>
            <span class="c1"># this implementation still supports custom type validation methods</span>
            <span class="n">type_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">,</span> <span class="n">type_definition</span><span class="o">.</span><span class="n">included_types</span>
                <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_definition</span><span class="o">.</span><span class="n">excluded_types</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rule_handler</span><span class="p">(</span><span class="s1">&#39;validate_type&#39;</span><span class="p">,</span> <span class="n">_type</span><span class="p">)</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">type_handler</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matched</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># TODO uncomment this block on next major release</span>
            <span class="c1">#      when _validate_type_* methods were deprecated:</span>
            <span class="c1"># type_definition = self.types_mapping[_type]</span>
            <span class="c1"># if isinstance(value, type_definition.included_types) \</span>
            <span class="c1">#         and not isinstance(value, type_definition.excluded_types):  # noqa 501</span>
            <span class="c1">#     return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">BAD_TYPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_remaining_rules</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_valuesrules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; {&#39;type&#39;: [&#39;dict&#39;, &#39;string&#39;], &#39;check_with&#39;: &#39;bulk_schema&#39;,</span>
<span class="sd">            &#39;forbidden&#39;: [&#39;rename&#39;, &#39;rename_handler&#39;]} &quot;&quot;&quot;</span>
        <span class="n">schema_crumb</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;valuesrules&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_child_validator</span><span class="p">(</span>
                <span class="n">document_crumb</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">schema_crumb</span><span class="o">=</span><span class="n">schema_crumb</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">value</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drop_nodes_from_errorpaths</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">VALUESRULES</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>


<span class="n">RULE_SCHEMA_SEPARATOR</span> <span class="o">=</span> <span class="s2">&quot;The rule&#39;s arguments are validated against this schema:&quot;</span>


<span class="k">class</span> <span class="nc">InspectedValidator</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Metaclass for all validators &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;__doc__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;__doc__&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">})</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">InspectedValidator</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">attributes_with_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">InspectedValidator</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_types_from_methods</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validation_rules</span> <span class="o">=</span> <span class="p">(),</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes_with_prefix</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">):</span>
            <span class="c1"># TODO remove inspection of type test methods in next major release</span>
            <span class="k">if</span> <span class="n">attribute</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;type_&#39;</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_types_from_methods</span> <span class="o">+=</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;type_&#39;</span><span class="p">)</span> <span class="p">:],)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">validation_rules</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rule_schema</span><span class="p">(</span>
                    <span class="s1">&#39;_validate_&#39;</span> <span class="o">+</span> <span class="n">attribute</span>
                <span class="p">)</span>

        <span class="c1"># TODO remove on next major release</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_types_from_methods</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Methods for type testing are deprecated, use TypeDefinition &quot;</span>
                <span class="s2">&quot;and the &#39;types_mapping&#39;-property of a Validator-instance &quot;</span>
                <span class="s2">&quot;instead.&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># TODO remove second summand on next major release</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">checkers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attributes_with_prefix</span><span class="p">(</span><span class="s1">&#39;check_with&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attributes_with_prefix</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validation_rules</span><span class="p">[</span><span class="s1">&#39;check_with&#39;</span><span class="p">][</span><span class="s1">&#39;oneof&#39;</span><span class="p">]</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;schema&#39;</span><span class="p">][</span><span class="s1">&#39;oneof&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">checkers</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mandatory_validations</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;nullable&#39;</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">validation_rules</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="s1">&#39;required&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">coercers</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_setters</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">normalization_rules</span> <span class="o">=</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes_with_prefix</span><span class="p">(</span><span class="s1">&#39;normalize&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attribute</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;coerce_&#39;</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">coercers</span> <span class="o">+=</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;coerce_&#39;</span><span class="p">)</span> <span class="p">:],)</span>
            <span class="k">elif</span> <span class="n">attribute</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;default_setter_&#39;</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">default_setters</span> <span class="o">+=</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;default_setter_&#39;</span><span class="p">)</span> <span class="p">:],)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">normalization_rules</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rule_schema</span><span class="p">(</span>
                    <span class="s1">&#39;_normalize_&#39;</span> <span class="o">+</span> <span class="n">attribute</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;coerce&#39;</span><span class="p">,</span> <span class="s1">&#39;rename_handler&#39;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">normalization_rules</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="s1">&#39;oneof&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;schema&#39;</span><span class="p">][</span><span class="s1">&#39;oneof&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">coercers</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">normalization_rules</span><span class="p">[</span><span class="s1">&#39;default_setter&#39;</span><span class="p">][</span><span class="s1">&#39;oneof&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span>
            <span class="s1">&#39;allowed&#39;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_setters</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">validation_rules</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">normalization_rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_rule_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">if</span> <span class="n">docstring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">RULE_SCHEMA_SEPARATOR</span> <span class="ow">in</span> <span class="n">docstring</span><span class="p">:</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RULE_SCHEMA_SEPARATOR</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">docstring</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s1">&#39;_validate_meta&#39;</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No validation schema is defined for the arguments of rule &quot;</span>
                <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">method_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="n">Validator</span> <span class="o">=</span> <span class="n">InspectedValidator</span><span class="p">(</span><span class="s1">&#39;Validator&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">BareValidator</span><span class="p">,),</span> <span class="p">{})</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018-2021 BASF SE, Matgenix SRL.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>